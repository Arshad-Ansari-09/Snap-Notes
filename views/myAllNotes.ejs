<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="icon" type="image/x-icon" href="/favicon.png">
    <title>Snap Notes</title>
    <meta name="description" content="Snap Notes — The best way for students to easily upload, share, and download handwritten notes. Keep things in order, and get to your study materials whenever you want. Quick, safe, and totally free.">
  </head>
  <body class="bg-stone-300">

    <%- include("./partials/navBar") %>

    <div
      class="scrollbar-hide mx-4 my-2 flex gap-2 flex-wrap justify-around h-[500px] overflow-auto mt-4"
    >
    <% if (notes.length > 0) { %>
     <% notes.forEach(note => { %>
      <div
        class="main border-1 border-stone-700 h-[305px] w-60 overflow-hidden rounded shadow-md/20 px-4 py-2 mb-2 scrollbar-hide"
      >
        <img
          class="preview-img h-44 w-full rounded object-cover cursor-pointer"
          src="<%= note.notesImages[0] %>"
          data-images='<%= JSON.stringify(note.notesImages) %>'
          alt=""
        />
        <div class="flex justify-between">
        <div class="noteDetail">
         <h1 class="line-clamp-1"><span class="font-semibold">Class name: </span><%= note.classname %></h1>
        <h1 class="line-clamp-1">
          <span class="font-semibold">Notes info:</span> <%= note.notesInfo %>
        </h1>
        <h1>
          <span class="font-semibold">By:</span> <%= note.user.username %>
        </h1>
        <div class="flex justify-between items-center">
          <a
            href="/deleteNotes/<%= note._id %>"
            class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded mt-2 cursor-pointer hover:bg-blue-800"
            >Delete</a
          >
          </div>
         </div>
          <form class="updateNotesForm hidden" action="/updateNote/<%= note._id %>" method="post">
            <input class="mt-3 border-1 border-stone-700 rounded pl-1 w-44" placeholder="Class Name" type="text" name="classname" value="<%= note.classname %>">
            <input class="mt-3 border-1 border-stone-700 rounded pl-1 w-44" placeholder="Notes Info" type="text" name="notesInfo" value="<%= note.notesInfo %>">
            <button
              type="submit"
              class="bg-yellow-600 hover:bg-yellow-500 text-white px-2 py-1 rounded mt-2 cursor-pointer hover:bg-blue-800"
              >Update</button
            >
          </form>
         <div class="flex justify-end items-start">
          <svg class="editBtn hover:fill-blue-600 cursor-pointer" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000"><path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Zm640-584-56-56 56 56Zm-141 85-28-29 57 57-29-28Z"/></svg>
        </div>
        </div>
      </div>
      <% }) %>
    <% } else { %> 
      <h1 class="text-center text-4xl">Upload to see your Notes.</h1>
      <% } %>
      
    </div>

    <style>
      .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }

    /* ✅ Image loading skeleton */
.image-loader {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%); /* Perfectly center */
  width: 60%;
  height: 60%;
  background: linear-gradient(90deg, #444 25%, #555 37%, #444 63%);
  background-size: 400% 100%;
  animation: shimmer 1.4s ease infinite;
  border-radius: 10px;
}

@keyframes shimmer {
  0% { background-position: -400px 0; }
  100% { background-position: 400px 0; }
}

.overlay img {
  transition: opacity 0.25s ease-in-out;
}


.image-counter {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  color: white;
  font-size: 1rem;
  font-weight: bold;
  background: rgba(0,0,0,0.5);
  padding: 5px 12px;
  border-radius: 12px;
  z-index: 1010;
}
    
  .overlay {
    position: fixed;
    top:0; left:0;
    width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  .overlay img {
    max-width: 90%;
    max-height: 80%;
    border-radius: 8px;
  }
  .nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 2rem;
      color: white;
      background: rgba(0,0,0,0.5);
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      border-radius: 50%;
   }
  #prevBtn { left: 20px; background-color: azure; color: black; }
  #nextBtn { right: 20px; background-color: azure; color: black; }
    </style>

<script>
    document.querySelectorAll(".editBtn").forEach((editBtn) => {
      const card = editBtn.closest(".main");
      const updateNotesForm = card.querySelector(".updateNotesForm");
      const noteDetail = card.querySelector(".noteDetail");
    
      editBtn.addEventListener("click", () => {
        if (updateNotesForm.classList.contains("hidden") && !noteDetail.classList.contains("hidden")) {
          updateNotesForm.classList.remove("hidden");
          noteDetail.classList.add("hidden");
        } else {
          updateNotesForm.classList.add("hidden");
          noteDetail.classList.remove("hidden");
        }
     });
   });

      // Logic for Image preview
      document.querySelectorAll(".preview-img").forEach(img => {
  img.addEventListener("click", () => {
    const images = JSON.parse(img.dataset.images);
    let currentIndex = 0;

    // Create overlay
    const overlay = document.createElement("div");
    overlay.classList.add("overlay");

    
    // Create counter
const counter = document.createElement("div");
counter.className = "image-counter";
counter.textContent = `${currentIndex + 1} / ${images.length}`; // e.g., 1 / 8
overlay.appendChild(counter);


const showImage = (index) => {
  displayImg.src = images[index];
  counter.textContent = `${index + 1} / ${images.length}`;
};


    // Image element
    // ✅ Loader skeleton
const loader = document.createElement("div");
loader.className = "image-loader";
overlay.appendChild(loader);

// ✅ Actual Image
const displayImg = document.createElement("img");
displayImg.style.opacity = "0";
displayImg.onload = () => {
  loader.remove();
  displayImg.style.opacity = "1";
};
displayImg.src = images[currentIndex];
overlay.appendChild(displayImg);


    // Navigation buttons
    const prevBtn = document.createElement("button");
    prevBtn.id = "prevBtn";
    prevBtn.classList.add("nav-btn");
    prevBtn.innerHTML = "&#10094;"; // Left arrow
    overlay.appendChild(prevBtn);

    const nextBtn = document.createElement("button");
    nextBtn.id = "nextBtn";
    nextBtn.classList.add("nav-btn");
    nextBtn.innerHTML = "&#10095;"; // Right arrow
    overlay.appendChild(nextBtn);


    // Show next image
    nextBtn.addEventListener("click", (e) => {
      let touchStartX = 0;
let touchEndX = 0;

overlay.addEventListener("touchstart", (e) => {
  touchStartX = e.changedTouches[0].screenX;
}, false);

overlay.addEventListener("touchend", (e) => {
  touchEndX = e.changedTouches[0].screenX;
  handleSwipe();
}, false);

function handleSwipe() {
  const swipeDistance = touchEndX - touchStartX;

  if (swipeDistance > 60) {
    // ✅ Swipe Right → Previous Image
    prevBtn.click();
  }

  if (swipeDistance < -60) {
    // ✅ Swipe Left → Next Image
    nextBtn.click();
  }
}
    e.stopPropagation();
    currentIndex = (currentIndex + 1) % images.length;
    showImage(currentIndex);
    displayImg.style.opacity = "0";

setTimeout(() => {
  displayImg.src = images[currentIndex];
}, 80);

    
    // ⭐ NEW: Start preloading the image that comes AFTER the next one
    const preloadIndex = (currentIndex + 1) % images.length;
    preloadImage(images[preloadIndex]); 
});

// Show previous image
prevBtn.addEventListener("click", (e) => {
  let touchStartX = 0;
let touchEndX = 0;

overlay.addEventListener("touchstart", (e) => {
  touchStartX = e.changedTouches[0].screenX;
}, false);

overlay.addEventListener("touchend", (e) => {
  touchEndX = e.changedTouches[0].screenX;
  handleSwipe();
}, false);

function handleSwipe() {
  const swipeDistance = touchEndX - touchStartX;

  if (swipeDistance > 60) {
    // ✅ Swipe Right → Previous Image
    prevBtn.click();
  }

  if (swipeDistance < -60) {
    // ✅ Swipe Left → Next Image
    nextBtn.click();
  }
}

    e.stopPropagation();
    currentIndex = (currentIndex - 1 + images.length) % images.length;
    showImage(currentIndex);
    displayImg.style.opacity = "0";

setTimeout(() => {
  displayImg.src = images[currentIndex];
}, 80);

    
    // ⭐ NEW: Start preloading the image that comes BEFORE the previous one
    const preloadIndex = (currentIndex - 1 + images.length) % images.length;
    preloadImage(images[preloadIndex]);
});


// ⭐ NEW FUNCTION: Function to handle the actual preloading
const preloadImage = (url) => {
    // 1. Check if the image is already in the cache (optional but good practice)
    if (!preloadImage.cache) preloadImage.cache = {};
    if (preloadImage.cache[url]) return;

    // 2. Create a temporary Image object
    const img = new Image();
    img.onload = () => {
        // Image loaded successfully, now it's in the browser cache!
        preloadImage.cache[url] = true;
    };
    img.onerror = () => {
        // Handle error if needed
        preloadImage.cache[url] = false;
    };
    
    // 3. Set the source to start downloading the file in the background
    img.src = url;
};

    // Keyboard support
    const keyHandler = (e) => {
      if (e.key === "ArrowLeft") prevBtn.click();
      if (e.key === "ArrowRight") nextBtn.click();
      if (e.key === "Escape") closeOverlay();
    };
    document.addEventListener("keydown", keyHandler);

    // Close overlay
    const closeOverlay = () => {
      overlay.remove();
      document.removeEventListener("keydown", keyHandler);
    };

    overlay.addEventListener("click", closeOverlay);

    document.body.appendChild(overlay);
  });
});

    </script>
  </body>
</html>
